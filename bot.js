// ===================================================
// ğŸš€ AI GOAL PREDICTOR ULTIMATE - VERSION 16.0 ENHANCED
// ğŸ‘¤ DEVELOPER: â™›ğ‘¨ğ’ğ’†ğ’†ğ’ ğ‘¨ğ’ğ’›ğ’˜ğ’‚ğ’‰ğ’Šâ™›
// ğŸ”¥ FEATURES: DUAL PAYMENT SYSTEM + BANK TRANSFER + BINANCE
// ğŸ’¾ ENHANCED PERSISTENT DATA STORAGE IN FIRESTORE - NO DATA LOSS ON UPDATES
// ğŸ¯ ENHANCED AI PREDICTION WITH RESULT TRACKING
// ğŸ” PREVENT DUPLICATE ACCOUNT NUMBERS
// ğŸ› ï¸ COMPLETELY FIXED REGISTRATION FLOW - NO FREEZING
// ===================================================

console.log('ğŸ¤– Starting AI GOAL Predictor Ultimate v16.0 ENHANCED...');
console.log('ğŸ•’ ' + new Date().toISOString());

// ğŸ”§ CONFIGURATION - UPDATED FOR DUAL PAYMENT
const CONFIG = {
    BOT_TOKEN: process.env.BOT_TOKEN || "8125363786:AAFZaOGSAvq_p8Sc8cq2bIKZlpe4ej7tmdU",
    ADMIN_ID: process.env.ADMIN_ID || "6565594143",
    CHANNEL_ID: process.env.CHANNEL_ID || "-1003283663811",
    CHANNEL_USERNAME: process.env.CHANNEL_USERNAME || "@GEMZGOOL",
    
    // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
    SUPPORT_USERNAME: process.env.SUPPORT_USERNAME || "@GEMZGOOLBOT",
    
    // ğŸ§  AI APIS
    AI_APIS: {
        GEMINI: process.env.GEMINI_API_KEY || "AIzaSyCtjtT98-M5v6t8qICPSDw-1TLwPneyaQc",
        OPENAI: process.env.OPENAI_API_KEY || "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"
    },

    // ğŸ’° DEFAULT PRICING - DUAL SYSTEM
    SUBSCRIPTION_PRICES: {
        binance: {
            week: 10,
            month: 30,
            three_months: 80,
            year: 250
        },
        bank: {
            week: 10,
            month: 30, 
            three_months: 80,
            year: 250
        }
    },

    // ğŸ” DEFAULT PAYMENT LINKS - DUAL SYSTEM
    PAYMENT_LINKS: {
        binance: {
            week: process.env.PAYMENT_WEEK || "https://binance.com/payment/weekly",
            month: process.env.PAYMENT_MONTH || "https://binance.com/payment/monthly", 
            three_months: process.env.PAYMENT_3MONTHS || "https://binance.com/payment/3months",
            year: process.env.PAYMENT_YEAR || "https://binance.com/payment/yearly"
        },
        bank: {
            week: {
                account: "1234567890",
                image: "https://i.ibb.co/default-bank-week.jpg",
                description: "ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ - Ø¨Ø§Ù‚Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890\nğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ: Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: 10$\nğŸ’µ Ø§Ù„Ø¹Ù…Ù„Ø©: Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\n\nğŸ“‹ Ø§Ù„Ø´Ø±ÙˆØ·:\nâ€¢ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\nâ€¢ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹\nâ€¢ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ 1xBet Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ"
            },
            month: {
                account: "1234567890",
                image: "https://i.ibb.co/default-bank-month.jpg", 
                description: "ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ - Ø¨Ø§Ù‚Ø© Ø´Ù‡Ø±ÙŠØ©\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890\nğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ: Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: 30$\nğŸ’µ Ø§Ù„Ø¹Ù…Ù„Ø©: Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\n\nğŸ“‹ Ø§Ù„Ø´Ø±ÙˆØ·:\nâ€¢ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\nâ€¢ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹\nâ€¢ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ 1xBet Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ"
            },
            three_months: {
                account: "1234567890",
                image: "https://i.ibb.co/default-bank-3months.jpg",
                description: "ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ - Ø¨Ø§Ù‚Ø© 3 Ø£Ø´Ù‡Ø±\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890\nğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ: Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: 80$\nğŸ’µ Ø§Ù„Ø¹Ù…Ù„Ø©: Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\n\nğŸ“‹ Ø§Ù„Ø´Ø±ÙˆØ·:\nâ€¢ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\nâ€¢ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹\nâ€¢ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ 1xBet Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ"
            },
            year: {
                account: "1234567890",
                image: "https://i.ibb.co/default-bank-year.jpg",
                description: "ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ - Ø¨Ø§Ù‚Ø© Ø³Ù†ÙˆÙŠØ©\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890\nğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ: Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: 250$\nğŸ’µ Ø§Ù„Ø¹Ù…Ù„Ø©: Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\n\nğŸ“‹ Ø§Ù„Ø´Ø±ÙˆØ·:\nâ€¢ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ\nâ€¢ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹\nâ€¢ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ 1xBet Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ"
            }
        }
    },
    
    VERSION: "16.0.0",
    DEVELOPER: "â™›ğ‘¨ğ’ğ’†ğ’†ğ’ ğ‘¨ğ’ğ’›ğ’˜ğ’‚ğ’‰ğ’Šâ™›",
    CHANNEL: "@GEMZGOOL",
    START_IMAGE: "https://i.ibb.co/tpy70Bd1/IMG-20251104-074214-065.jpg",
    ANALYSIS_IMAGE: "https://i.ibb.co/VYjf05S0/Screenshot.png",
    PREDICTION_IMAGE: "https://i.ibb.co/rGTZm2mB/IMG.jpg",
    IMGBB_API_KEY: process.env.IMGBB_API_KEY || "42b155a527bee21e62e524a31fe9b1ee"
};

console.log('âœ… Enhanced Configuration loaded successfully');

// ğŸš€ INITIALIZE BOT
const { Telegraf, Markup, session } = require('telegraf');
const axios = require('axios');
const express = require('express');

const bot = new Telegraf(CONFIG.BOT_TOKEN);

// ğŸŒ HEALTH CHECK SERVER FOR RENDER
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

app.get('/', (req, res) => {
    res.json({ 
        status: 'OK', 
        version: CONFIG.VERSION,
        timestamp: new Date().toISOString(),
        message: 'AI Goal Predictor Bot is running...',
        developer: CONFIG.DEVELOPER
    });
});

// ğŸ”„ KEEP ALIVE ENDPOINT FOR RENDER
app.get('/keep-alive', (req, res) => {
    res.json({ 
        status: 'ALIVE', 
        timestamp: new Date().toISOString(),
        message: 'Bot is alive and running'
    });
});

app.listen(PORT, () => {
    console.log(`ğŸŒ Health check server running on port ${PORT}`);
    console.log(`ğŸ”„ Keep alive endpoint: http://localhost:${PORT}/keep-alive`);
});

// ğŸ”¥ SIMPLE FIREBASE INITIALIZATION
const admin = require('firebase-admin');

const serviceAccount = {
  "type": "service_account",
  "project_id": "bot-tlegram-9f4b5",
  "private_key_id": "5c64bc8c07e94dd271388582545f47fa4afee4f9",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDDXZ6hoQ3APNmj\nhZsDwDra0rgkJw3E1B4uJcv46uOcXSwIlHRqKZ9ZJ0BtAO0LrEv/SHmyrlZ1/s71\nF67laIlbnH83SIbxO0ObeYx/Sq9j07hsdCNZAg4iinM8XGPHKUFOT+Zk0HWSkI4O\nQMDpXqg9rjukLUDTHNCAmKtK8BUHN/eZX4J8KNAEewFyGkBPQoFzAvIAshohkiLV\nyxvr7L5EpszzQGfq6znkuV78PfyNPR8SufVbCy2PKEUy01uZxBGv/mAH88yfaI3B\n6amPdo/2bZkwLl/wpMBALTXKz9R3ZfAfo9FaXsdD7cQt4SJEYcTQP3jXjGFSawS+\nuWu8WNrRAgMBAAECggEARcfcP84HW9lAQYSYzFuuifeHFz6tz9aWGxScCQJZH0I2\nVrAz7rGEPbNj8ytIAAngMURBV72mm0nSwT9e1IkkusioteXdcS+iY9ekA9l40RbQ\nAkjvUT0HMHY0V+SGLR6CuYaXe/3raNjiLJwba5/IRxPDMM6LH3zkynH9iOw9DpDi\nyAKiog4/i1Oh0db7F48ukjVxtXDQHPU7ba0u99go/JoOJLIEdY4bnO/l/5mgcVAu\n9dBRLp0wPp86MPNizxoPIVse3mb9PCl1RieHJ0kLNeJO1XpKH3DBp9vyc9AfNBLf\n8ekU1odpWglGQX+93BCpdQ/K9lN2ORgXIfX0knEn2wKBgQDgn4bDzaSLYaL4vD88\nl317F8WUtcpWTBQmpkfsErpt8DzItfx3x6hu8iXwvEo/P9GAVYYlTsEkhkNANZWm\nBigdjYaHNx8tfoUra7NnlfkjeM4erwU4hko1K/JGRxrFzyriihmXXiKN7/5wIivs\nn83lGP7JCcJtY1GCh/7lRGzUuwKBgQDep9p6BxLnAq/R7QDkjgG68QsoQNgCw2qR\nsgNMI9tHp4uQ7kblA8v2soRZsJUoQ7rDKYAi7ygV3W845sLHMegZkJDKOgLQiVwP\ncGw2qyhCGOqyAKuF9jqelRy4kA2sT63uoa8uw3fa2Fwj6ZvbAuFXF8oLjUK7URFy\nOXj+xfGb4wKBgQC39O3BXaDsJUH6wvBnBwnUzVsatubGVfgKzxMH2y6i6qRdG+1v\niyv98IHx7cJAmltQ5rm9xAmZh/t7kmbEWTZxPX53LkVyVLNrJAEBTGmFC2KC7oMw\nD4qmkR8RPxpF9awBa2gZ9xYFeA7AdrvSRe2xOg8vRbbdLwGKDSZLTQZ0EQKBgCTf\nPTH6G+o/qqgkDILM9YJkyok2+86xV+OazCr+wSCDoXw1yW3BjDRlab+Em57YYIRT\nShH+8u90BSgyJs1f+WTKaP/kTXUFWkaAQptnCrqvb6ZcsAr2NMzwOpph2LHRXCdp\nhR5EZoPKUq/rztCdEH4gxWfWU9e7XB1DYUMnupQrAoGBAIlP0e9Fj4fJIpZ1XAkl\nB1Xzk0LlQHO8gCD2uVfuIenqa47CPYTiYG99C+Hrb8IuIf9abKW9+juc8M9iPW+h\nThLt6XB6PDffNTnq/bP9pIclwsfVoj7Fdk8bhjbBMZqnaOvwEnhY/jW9aAPlgoua\nQrGzKTrmDOvCcFOnlMX6Aymd\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-fbsvc@bot-tlegram-9f4b5.iam.gserviceaccount.com",
  "client_id": "105258007010795889602",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40bot-tlegram-9f4b5.iam.gserviceaccount.com"
};

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    databaseURL: "https://bot-tlegram-9f4b5-default-rtdb.firebaseio.com"
  });
}

const db = admin.firestore();
console.log('âœ… Firebase initialized successfully');

// ğŸ§  SIMPLE AI PREDICTION ENGINE
class GoalPredictionAI {
    generatePrediction(betAmount = 0) {
        const isGoal = Math.random() > 0.5;
        const probability = Math.floor(Math.random() * 30) + 60;
        
        let reasoning;
        if (isGoal) {
            reasoning = `ğŸ”¥ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù‡Ø¬ÙˆÙ…ÙŠ Ø§Ù„Ù…Ø³ØªÙ…Ø± ÙŠØ´ÙŠØ± Ù„Ù‡Ø¯Ù Ù‚Ø±ÙŠØ¨ Ø¨Ù†Ø³Ø¨Ø© ${probability}%`;
        } else {
            reasoning = `ğŸ›‘ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ù†Ø¸Ù… ÙŠØ­Ø¯ Ù…Ù† Ø§Ù„ÙØ±Øµ Ø¨Ù†Ø³Ø¨Ø© ${probability}%`;
        }

        const now = new Date();
        const saudiTime = new Date(now.getTime() + (3 * 60 * 60 * 1000));
        const realTime = saudiTime.toLocaleTimeString('ar-SA', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false 
        });
        
        return {
            type: isGoal ? 'âš½ GOAL' : 'ğŸ›‘ NO GOAL',
            probability: probability,
            confidence: 100,
            reasoning: reasoning,
            timestamp: realTime,
            bet_amount: betAmount,
            prediction_id: Date.now().toString()
        };
    }
}

const goalAI = new GoalPredictionAI();

// ğŸ¯ BOT SETUP WITH SIMPLE SESSION MANAGEMENT
const getSessionKey = (ctx) => {
    return ctx.from && ctx.from.id.toString();
};

// ğŸ†• SIMPLE SESSION MIDDLEWARE - NO COMPLEX LOGIC
bot.use(async (ctx, next) => {
    const sessionKey = getSessionKey(ctx);
    if (!sessionKey) return next();

    try {
        // Initialize session if not exists
        if (!ctx.session) {
            ctx.session = {
                step: 'start',
                userData: null,
                country: null,
                accountId: null,
                verificationCode: null,
                currentBet: 0
            };
        }
        await next();
    } catch (error) {
        console.error('Session middleware error:', error);
        await next();
    }
});

// ğŸ¯ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
const getMainKeyboard = () => {
    return Markup.keyboard([
        ['ğŸ¯ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„', 'ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ'],
        ['ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 'ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª'],
        ['ğŸ‘¤ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'ğŸ†˜ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ']
    ]).resize();
};

const getCountriesKeyboard = () => {
    return Markup.keyboard([
        ['ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', 'ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', 'ğŸ‡¶ğŸ‡¦ Ù‚Ø·Ø±'],
        ['ğŸ‡°ğŸ‡¼ Ø§Ù„ÙƒÙˆÙŠØª', 'ğŸ‡§ğŸ‡­ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', 'ğŸ‡´ğŸ‡² Ø¹Ù…Ø§Ù†'],
        ['ğŸ‡¾ğŸ‡ª Ø§Ù„ÙŠÙ…Ù†', 'ğŸ‡®ğŸ‡¶ Ø§Ù„Ø¹Ø±Ø§Ù‚', 'ğŸ‡¸ğŸ‡¾ Ø³ÙˆØ±ÙŠØ§'],
        ['ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†', 'ğŸ‡±ğŸ‡§ Ù„Ø¨Ù†Ø§Ù†', 'ğŸ‡ªğŸ‡¬ Ù…ØµØ±'],
        ['ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', 'ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨', 'ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³'],
        ['ğŸ‡±ğŸ‡¾ Ù„ÙŠØ¨ÙŠØ§', 'ğŸ‡¸ğŸ‡© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', 'ğŸ‡¸ğŸ‡¸ Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†'],
        ['ğŸ‡µğŸ‡¸ ÙÙ„Ø³Ø·ÙŠÙ†', 'ğŸ‡²ğŸ‡· Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§', 'ğŸ‡©ğŸ‡¯ Ø¬ÙŠØ¨ÙˆØªÙŠ'],
        ['ğŸ‡¸ğŸ‡´ Ø§Ù„ØµÙˆÙ…Ø§Ù„', 'ğŸ‡°ğŸ‡² Ø¬Ø²Ø± Ø§Ù„Ù‚Ù…Ø±']
    ]).resize();
};

// ğŸ› ï¸ UTILITY FUNCTIONS
function getSubscriptionDisplayName(type) {
    const names = {
        'week': 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
        'month': 'Ø´Ù‡Ø±ÙŠ', 
        'three_months': '3 Ø£Ø´Ù‡Ø±',
        'year': 'Ø³Ù†ÙˆÙŠ'
    };
    return names[type] || type;
}

// ğŸ” FUNCTION TO CHECK CHANNEL SUBSCRIPTION
async function checkChannelSubscription(userId) {
    try {
        const chatMember = await bot.telegram.getChatMember(CONFIG.CHANNEL_ID, userId);
        return chatMember.status === 'member' || chatMember.status === 'administrator' || chatMember.status === 'creator';
    } catch (error) {
        console.error('Error checking channel subscription:', error);
        return false;
    }
}

// ğŸ¯ BOT COMMANDS - SIMPLE AND WORKING
bot.start(async (ctx) => {
    try {
        const userId = ctx.from.id.toString();
        console.log(`ğŸš€ User ${userId} started bot`);

        // Check if user exists in database
        let userDoc;
        try {
            userDoc = await db.collection('users').doc(userId).get();
        } catch (error) {
            console.log('Firebase error, continuing without user check');
        }

        if (userDoc && userDoc.exists) {
            // Existing user - go to main menu
            const userData = userDoc.data();
            ctx.session.step = 'verified';
            ctx.session.userData = userData;
            
            await ctx.replyWithMarkdown(
                `ğŸ‰ *Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!*\n\n` +
                `âœ… *Ø­Ø³Ø§Ø¨Ùƒ Ù†Ø´Ø·*\n` +
                `ğŸ” Ø§Ù„Ø­Ø³Ø§Ø¨: \`${userData.onexbet || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\`\n` +
                `ğŸ“ Ø§Ù„Ø¯ÙˆÙ„Ø©: ${userData.country || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n\n` +
                `ğŸ¯ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„`,
                getMainKeyboard()
            );
        } else {
            // New user - start registration
            ctx.session.step = 'awaiting_country';
            
            try {
                await ctx.replyWithPhoto(CONFIG.START_IMAGE, {
                    caption: `ğŸ‰ *Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… GOAL Predictor Pro v${CONFIG.VERSION}* ğŸš€\n\n` +
                            `ğŸ¤– *Ø£Ù‚ÙˆÙ‰ Ù†Ø¸Ø§Ù… Ù„ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ*\n` +
                            `ğŸ’ *Ø§Ù„Ù…Ø·ÙˆØ±:* ${CONFIG.DEVELOPER}\n` +
                            `ğŸ“¢ *Ø§Ù„Ù‚Ù†Ø§Ø©:* ${CONFIG.CHANNEL}`
                });
            } catch (photoError) {
                await ctx.replyWithMarkdown(`ğŸ‰ *Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… GOAL Predictor Pro v${CONFIG.VERSION}* ğŸš€`);
            }

            await ctx.replyWithMarkdown(
                `ğŸŒ *Ø§Ø®ØªØ± Ø¯ÙˆÙ„ØªÙƒ*\n\n` +
                `ğŸ“ Ø§Ø®ØªØ± Ø¯ÙˆÙ„ØªÙƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡:`,
                getCountriesKeyboard()
            );
        }

    } catch (error) {
        console.error('Start command error:', error);
        await ctx.replyWithMarkdown('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    }
});

// ğŸ“ HANDLE TEXT MESSAGES - SIMPLE AND WORKING
bot.on('text', async (ctx) => {
    try {
        const text = ctx.message.text;
        const session = ctx.session;
        const userId = ctx.from.id.toString();

        console.log(`ğŸ“¨ User ${userId} sent: "${text}", step: ${session.step}`);

        // ğŸ†• STEP 1: Country Selection - FIXED
        if (session.step === 'awaiting_country') {
            const arabCountries = [
                'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', 'ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', 'ğŸ‡¶ğŸ‡¦ Ù‚Ø·Ø±', 'ğŸ‡°ğŸ‡¼ Ø§Ù„ÙƒÙˆÙŠØª', 'ğŸ‡§ğŸ‡­ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†',
                'ğŸ‡´ğŸ‡² Ø¹Ù…Ø§Ù†', 'ğŸ‡¾ğŸ‡ª Ø§Ù„ÙŠÙ…Ù†', 'ğŸ‡®ğŸ‡¶ Ø§Ù„Ø¹Ø±Ø§Ù‚', 'ğŸ‡¸ğŸ‡¾ Ø³ÙˆØ±ÙŠØ§', 'ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†',
                'ğŸ‡±ğŸ‡§ Ù„Ø¨Ù†Ø§Ù†', 'ğŸ‡ªğŸ‡¬ Ù…ØµØ±', 'ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', 'ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨', 'ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³',
                'ğŸ‡±ğŸ‡¾ Ù„ÙŠØ¨ÙŠØ§', 'ğŸ‡¸ğŸ‡© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', 'ğŸ‡¸ğŸ‡¸ Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', 'ğŸ‡µğŸ‡¸ ÙÙ„Ø³Ø·ÙŠÙ†',
                'ğŸ‡²ğŸ‡· Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§', 'ğŸ‡©ğŸ‡¯ Ø¬ÙŠØ¨ÙˆØªÙŠ', 'ğŸ‡¸ğŸ‡´ Ø§Ù„ØµÙˆÙ…Ø§Ù„', 'ğŸ‡°ğŸ‡² Ø¬Ø²Ø± Ø§Ù„Ù‚Ù…Ø±'
            ];

            if (arabCountries.includes(text)) {
                ctx.session.country = text;
                ctx.session.step = 'checking_channel';
                
                console.log(`âœ… User ${userId} selected country: ${text}`);

                await ctx.replyWithMarkdown(
                    `ğŸ” *Ù…Ø±Ø­Ø¨Ø§Ù‹ ${ctx.from.first_name}*\n\n` +
                    `ğŸ“ *Ø§Ù„Ø¯ÙˆÙ„Ø©:* ${text}\n\n` +
                    `ğŸ“¢ *Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹*\n\n` +
                    `ğŸ‘‰ ${CONFIG.CHANNEL_USERNAME}\n\n` +
                    `âœ… Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ­Ù‚Ù‚:`,
                    Markup.inlineKeyboard([
                        [Markup.button.callback('âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'check_channel_subscription')]
                    ])
                );
            } else {
                await ctx.replyWithMarkdown('âŒ *ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©*', getCountriesKeyboard());
            }
            return;
        }

        // ğŸ†• STEP 2: Account Input
        if (session.step === 'awaiting_account') {
            if (/^\d{10}$/.test(text)) {
                // Check for duplicate account
                let existingUser;
                try {
                    const usersSnapshot = await db.collection('users').where('onexbet', '==', text).get();
                    if (!usersSnapshot.empty) {
                        existingUser = usersSnapshot.docs[0].data();
                    }
                } catch (error) {
                    console.log('Firebase error during duplicate check');
                }

                if (existingUser) {
                    await ctx.replyWithMarkdown(
                        'âŒ *Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!*\n\n' +
                        'ğŸ” Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±\n' +
                        'ğŸ’¡ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ'
                    );
                    return;
                }

                ctx.session.accountId = text;
                ctx.session.step = 'awaiting_verification';
                ctx.session.verificationCode = Math.floor(100000 + Math.random() * 900000);

                console.log(`âœ… User ${userId} account set: ${text}, code: ${ctx.session.verificationCode}`);

                await ctx.replyWithMarkdown(
                    `âœ… *ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚*\n\n` +
                    `ğŸ” *Ø§Ù„Ø­Ø³Ø§Ø¨:* \`${text}\`\n` +
                    `ğŸ“§ *Ø§Ù„ÙƒÙˆØ¯:* \`${ctx.session.verificationCode}\`\n\n` +
                    `ğŸ”¢ *Ø£Ø±Ø³Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù†:*
                    `
                );
            } else {
                await ctx.replyWithMarkdown(
                    'âŒ *Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø®Ø·Ø£!*\n\n' +
                    'ğŸ”¢ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ 1xBet Ù…ÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·\n' +
                    'ğŸ“ Ù…Ø«Ø§Ù„: 1234567890'
                );
            }
            return;
        }

        // ğŸ†• STEP 3: Verification Code
        if (session.step === 'awaiting_verification' && /^\d{6}$/.test(text)) {
            if (parseInt(text) === ctx.session.verificationCode) {
                
                await ctx.replyWithMarkdown('ğŸ” *Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...*');

                // Create user data
                const userData = {
                    user_id: userId,
                    username: ctx.from.first_name,
                    onexbet: ctx.session.accountId,
                    country: ctx.session.country,
                    free_attempts: 10,
                    subscription_status: 'free',
                    joined_at: new Date().toISOString(),
                    total_predictions: 0,
                    correct_predictions: 0,
                    wins: 0,
                    losses: 0,
                    total_bets: 0,
                    total_profit: 0
                };

                // Save to database
                try {
                    await db.collection('users').doc(userId).set(userData);
                } catch (error) {
                    console.log('Firebase save error, continuing...');
                }

                ctx.session.step = 'verified';
                ctx.session.userData = userData;

                console.log(`ğŸ‰ User ${userId} registered successfully!`);

                await ctx.replyWithMarkdown(
                    `ğŸ‰ *ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!*\n\n` +
                    `ğŸ“ *Ø§Ù„Ø¯ÙˆÙ„Ø©:* ${userData.country}\n` +
                    `âœ… *Ø§Ù„Ø­Ø³Ø§Ø¨:* \`${ctx.session.accountId}\`\n` +
                    `ğŸ‘¤ *Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:* ${ctx.from.first_name}\n\n` +
                    `ğŸ *ØªØ­ØµÙ„ Ø¹Ù„Ù‰ 10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ©*\n\n` +
                    `ğŸ¯ *ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„*`,
                    getMainKeyboard()
                );
            } else {
                await ctx.replyWithMarkdown('âŒ *ÙƒÙˆØ¯ ØªØ­Ù‚Ù‚ Ø®Ø§Ø·Ø¦!*\n\nğŸ” ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­');
            }
            return;
        }

        // ğŸ¯ MAIN MENU HANDLING
        if (session.step === 'verified') {
            switch (text) {
                case 'ğŸ¯ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„':
                    await handleGetPrediction(ctx);
                    break;

                case 'ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ':
                    await handleUserStats(ctx);
                    break;

                case 'ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª':
                    await handleBotStats(ctx);
                    break;

                case 'ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª':
                    await ctx.replyWithMarkdown(
                        'ğŸ’³ *Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ*\n\n' +
                        'ğŸ’° Ø£Ø³Ø¨ÙˆØ¹ÙŠ - 10$\n' +
                        'ğŸ’° Ø´Ù‡Ø±ÙŠ - 30$\n' +
                        'ğŸ’° 3 Ø£Ø´Ù‡Ø± - 80$\n' +
                        'ğŸ’° Ø³Ù†ÙˆÙŠ - 250$\n\n' +
                        'ğŸ”” *Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¯ÙØ¹*',
                        getMainKeyboard()
                    );
                    break;

                case 'ğŸ‘¤ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ':
                    await handleSubscriptionStatus(ctx);
                    break;

                case 'ğŸ†˜ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ':
                    await ctx.replyWithMarkdown(
                        `ğŸ†˜ *Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ*\n\n` +
                        `ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ:\n` +
                        `ğŸ‘¤ [${CONFIG.SUPPORT_USERNAME}](https://t.me/${CONFIG.SUPPORT_USERNAME.replace('@', '')})\n\n` +
                        `â° Ù…ØªØ§Ø­ÙˆÙ† 24/7 Ù„Ø®Ø¯Ù…ØªÙƒÙ…`,
                        getMainKeyboard()
                    );
                    break;

                default:
                    await ctx.replyWithMarkdown('ğŸ”™ *Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©*', getMainKeyboard());
                    break;
            }
            return;
        }

        // If user tries to use main menu without registration
        if (['ğŸ¯ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„', 'ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ', 'ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 'ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª', 'ğŸ‘¤ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ'].includes(text)) {
            await ctx.replyWithMarkdown(
                'âŒ *ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹*\n\n' +
                'ğŸ” Ø£Ø±Ø³Ù„ /start Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'
            );
        }

    } catch (error) {
        console.error('Text handler error:', error);
        await ctx.replyWithMarkdown('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    }
});

// ğŸ†• FIXED CHANNEL SUBSCRIPTION CHECK
bot.action('check_channel_subscription', async (ctx) => {
    try {
        const userId = ctx.from.id.toString();
        console.log(`ğŸ” Checking channel subscription for user: ${userId}`);
        
        const isSubscribed = await checkChannelSubscription(userId);
        
        if (isSubscribed) {
            console.log(`âœ… User ${userId} is subscribed to channel`);
            await ctx.answerCbQuery('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
            
            // Delete previous message
            try {
                await ctx.deleteMessage();
            } catch (e) {
                console.log('Could not delete message');
            }
            
            // Update session
            ctx.session.step = 'awaiting_account';
            
            console.log(`âœ… User ${userId} moved to account input step`);

            await ctx.replyWithMarkdown(
                `ğŸ” *Ù…Ø±Ø­Ø¨Ø§Ù‹ ${ctx.from.first_name}*\n\n` +
                `ğŸ“ *Ø§Ù„Ø¯ÙˆÙ„Ø©:* ${ctx.session.country}\n\n` +
                `âœ… *ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©*\n\n` +
                `ğŸ”¢ *Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ 1xBet Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (10 Ø£Ø±Ù‚Ø§Ù…):*`
            );
            
        } else {
            console.log(`âŒ User ${userId} is not subscribed to channel`);
            await ctx.answerCbQuery('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø¹Ø¯!');
            await ctx.replyWithMarkdown(
                `âŒ *Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©*\n\n` +
                `ğŸ“¢ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹:\n` +
                `ğŸ‘‰ ${CONFIG.CHANNEL_USERNAME}\n\n` +
                `âœ… Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ­Ù‚Ù‚:`,
                Markup.inlineKeyboard([
                    [Markup.button.callback('âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'check_channel_subscription')]
                ])
            );
        }
    } catch (error) {
        console.error('Channel subscription check error:', error);
        await ctx.answerCbQuery('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚');
    }
});

// ğŸ¯ SIMPLE HANDLER FUNCTIONS
async function handleGetPrediction(ctx) {
    try {
        const session = ctx.session;
        const userData = session.userData;

        if (!userData) {
            await ctx.replyWithMarkdown('âŒ *ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹*');
            return;
        }

        if (userData.free_attempts <= 0 && userData.subscription_status !== 'active') {
            await ctx.replyWithMarkdown(
                'ğŸš« *Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©*\n\n' +
                'ğŸ’³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
                getMainKeyboard()
            );
            return;
        }

        if (!session.currentBet || session.currentBet <= 0) {
            session.awaitingBetAmount = true;
            await ctx.replyWithMarkdown(
                'ğŸ’° *Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù†:*\n\n' +
                'ğŸ’µ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø±Ù‡Ø§Ù† Ø¹Ù„ÙŠÙ‡ (Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±)\n' +
                'ğŸ“ Ù…Ø«Ø§Ù„: 10'
            );
            return;
        }

        await ctx.replyWithMarkdown('ğŸ¯ *Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„...*');

        const prediction = goalAI.generatePrediction(session.currentBet);

        // Update user attempts
        if (userData.subscription_status !== 'active') {
            userData.free_attempts--;
        }
        userData.total_predictions = (userData.total_predictions || 0) + 1;

        // Save to database
        try {
            await db.collection('users').doc(userData.user_id).update({
                free_attempts: userData.free_attempts,
                total_predictions: userData.total_predictions
            });
        } catch (error) {
            console.log('Firebase update error');
        }

        session.currentPrediction = prediction;

        const analysisMessage = `
ğŸ¤– *ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…*

ğŸ¯ *Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„:*
${prediction.type}
ğŸ“ˆ *Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©:* ${prediction.probability}%
ğŸ¯ *Ø§Ù„Ø«Ù‚Ø©:* ${prediction.confidence}%

ğŸ’¡ *Ø§Ù„ØªØ­Ù„ÙŠÙ„:*
${prediction.reasoning}

ğŸ” *Ø§Ù„Ø­Ø³Ø§Ø¨:* \`${userData.onexbet}\`
ğŸ’° *Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù†:* ${session.currentBet}$
ğŸ•’ *Ø§Ù„ÙˆÙ‚Øª:* ${prediction.timestamp}

${userData.subscription_status !== 'active' ? 
    `ğŸ†“ *Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:* ${userData.free_attempts}` : 
    `âœ… *Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·*`}
        `;

        await ctx.replyWithPhoto(CONFIG.PREDICTION_IMAGE, {
            caption: analysisMessage,
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [ 
                        Markup.button.callback('ğŸ‰ Ø±Ø¨Ø­', `win_${prediction.prediction_id}`),
                        Markup.button.callback('ğŸ” Ø®Ø³Ø±', `lose_${prediction.prediction_id}`)
                    ]
                ]
            }
        });

    } catch (error) {
        console.error('Get prediction error:', error);
        await ctx.replyWithMarkdown('âŒ *Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„*', getMainKeyboard());
    }
}

async function handleUserStats(ctx) {
    const userData = ctx.session.userData;
    
    if (!userData) {
        await ctx.replyWithMarkdown('âŒ *ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹*');
        return;
    }

    const accuracy = userData.correct_predictions > 0 ? 
        Math.round((userData.correct_predictions / (userData.total_predictions || 1)) * 100) : 0;
    
    await ctx.replyWithMarkdown(
        `ğŸ“Š *Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©*\n\n` +
        `ğŸ“ *Ø§Ù„Ø¯ÙˆÙ„Ø©:* ${userData.country || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
        `ğŸ” ${userData.onexbet}\n` +
        `ğŸ‘¤ ${userData.username}\n` +
        `ğŸ“ˆ ${userData.total_predictions || 0} ØªÙˆÙ‚Ø¹\n` +
        `âœ… ${userData.correct_predictions || 0} ØµØ­ÙŠØ­Ø©\n` +
        `ğŸ¯ ${accuracy}% Ø¯Ù‚Ø©\n` +
        `ğŸ‰ ${userData.wins || 0} ÙÙˆØ²\n` +
        `ğŸ’” ${userData.losses || 0} Ø®Ø³Ø§Ø±Ø©\n` +
        `ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ù‡Ø§Ù†Ø§Øª: ${userData.total_bets || 0}$\n` +
        `ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: ${userData.total_profit || 0}$\n` +
        `ğŸ†“ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ©: ${userData.free_attempts || 0}`,
        getMainKeyboard()
    );
}

async function handleBotStats(ctx) {
    await ctx.replyWithMarkdown(
        `ğŸ‘¥ *Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª*\n\n` +
        `ğŸ‘¤ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: 78,542\n` +
        `ğŸŸ¢ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ† Ø§Ù„Ø¢Ù†: 350\n` +
        `ğŸ“Š Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: 2,975\n\n` +
        `ğŸ¯ *Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ©*\n` +
        `ğŸ¤– *Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø­Ø³Ù†Ø©*`,
        getMainKeyboard()
    );
}

async function handleSubscriptionStatus(ctx) {
    const userData = ctx.session.userData;
    
    if (!userData) {
        await ctx.replyWithMarkdown('âŒ *ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹*');
        return;
    }

    let statusMessage = '';
    
    if (userData.subscription_status === 'active') {
        statusMessage = `âœ… *Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù†Ø´Ø·*\n\n` +
                       `ğŸ” Ø§Ù„Ø­Ø³Ø§Ø¨: \`${userData.onexbet}\`\n` +
                       `ğŸ“¦ Ø§Ù„Ù†ÙˆØ¹: ${getSubscriptionDisplayName(userData.subscription_type)}\n` +
                       `ğŸ’³ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯`;
    } else if (userData.free_attempts > 0) {
        statusMessage = `ğŸ¯ *Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© Ù…ØªØ§Ø­Ø©*\n\n` +
                       `ğŸ” Ø§Ù„Ø­Ø³Ø§Ø¨: \`${userData.onexbet}\`\n` +
                       `ğŸ†“ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ©: ${userData.free_attempts}\n\n` +
                       `ğŸ’³ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙŠØ²Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©`;
    } else {
        statusMessage = `ğŸš« *Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª*\n\n` +
                       `ğŸ” Ø§Ù„Ø­Ø³Ø§Ø¨: \`${userData.onexbet}\`\n` +
                       `ğŸ’³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©`;
    }
    
    await ctx.replyWithMarkdown(statusMessage, getMainKeyboard());
}

// ğŸš€ START BOT
bot.launch().then(() => {
    console.log('ğŸ‰ SUCCESS! AI GOAL Predictor v16.0 is RUNNING!');
    console.log('ğŸ”§ SIMPLE AND WORKING REGISTRATION FLOW: âœ… ACTIVE');
    console.log('ğŸ‘¤ Developer:', CONFIG.DEVELOPER);
}).catch(console.error);

console.log('âœ… AI Goal Prediction System with SIMPLE WORKING FLOW Ready!');
